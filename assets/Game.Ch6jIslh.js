import{d as j,B as J,C as ee,p as y,l as B,D as te,E as se,F as oe,G as X,c as P,f as k,x as C,a as t,n as E,t as O,H as ne,q as e,s as c,I as T,J as I,w,K as R,L as ae,y as W,T as V,M as L,N,_ as A,O as H,o as d,Q as le,R as ie,A as z,S as Y,U as q,V as re,k as U,W as ce,X as ue,z as de}from"./index.DTA0rLxR.js";import"./IsNumberOrRangeConstraint.B_UE5vHo.js";import{u as K,a as F,S as ge}from"./Scene.VVuUWIcn.js";import{A as fe}from"./auth.api.CErS-Rg5.js";const pe={class:"flex items-center gap-2"},he={class:"flex items-center gap-1"},we={key:0,class:"text-center text-sm text-muted-foreground py-8"},me=["onClick"],ve={class:"flex items-start justify-between gap-2 mb-1"},be={class:"flex items-center gap-1 flex-1 min-w-0"},xe={class:"text-muted-foreground text-[10px] whitespace-nowrap"},ye={class:"px-4 py-2 border-t border-border bg-background/50 flex items-center justify-between text-xs text-muted-foreground"},ke={class:"text-[10px]"},_e=j({__name:"DebugConsole",setup(n){const i=J(),g=ee(),f=y(null),o=y(null),u=y(null),m=y(!1),h=y({x:0,y:0,width:0,height:0}),p=y([]),S=y(null),_=y(new Set),x=B({get:()=>({width:g.debugConsole.width,height:g.debugConsole.height}),set:s=>g.updateDebugConsole({width:s.width,height:s.height})});K("debug",{log(s){p.value.push(s)}});const{x:$,y:l}=te(f,{initialValue:{x:g.debugConsole.x,y:g.debugConsole.y},handle:o});function r(s){return{"text-green-500":s.type.includes("connect"),"text-red-500":s.type.includes("error")||s.type.includes("disconnect"),"text-blue-500":s.type.includes("match"),"text-yellow-500":s.type.includes("system"),"text-purple-500":s.type.includes("whisper"),"text-gray-500":s.type.includes("pong")}}function v(){p.value=[],_.value.clear()}function a(s){_.value.has(s)?_.value.delete(s):_.value.add(s)}function Q(){const s={x:window.innerWidth-400-16,y:64,width:400,height:Math.min(window.innerHeight*.6,600)};g.updateDebugConsole(s),$.value=s.x,l.value=s.y}function Z(s){if(typeof s=="string")return s;if(typeof s=="object")try{return JSON.stringify(s,null,2)}catch{return String(s)}return String(s)}return se([$,l],([s,b])=>{const D=Math.round(s),M=Math.round(b);$.value=D,l.value=M,g.updateDebugConsole({x:D,y:M})},{debounce:300}),oe(u,{onSwipeStart:s=>{m.value=!0,h.value={x:s.x,y:s.y,width:x.value.width,height:x.value.height}},onSwipe:s=>{if(!m.value)return;const b=s.x-h.value.x,D=s.y-h.value.y,M=Math.max(300,h.value.width+b),G=Math.max(200,h.value.height+D);x.value={width:M,height:G}},onSwipeEnd:()=>{x.value={width:Math.round(x.value.width),height:Math.round(x.value.height)},m.value=!1}}),X(()=>p.value.length,async()=>{await le(),S.value&&(S.value.scrollTop=S.value.scrollHeight)}),(s,b)=>(d(),P(V,{to:"body"},[t(i).debug.showWebSocketDebugger?(d(),k("div",{key:0,ref_key:"draggableContainer",ref:f,style:ne({left:`${t($)}px`,top:`${t(l)}px`,width:`${x.value.width}px`,height:`${x.value.height}px`}),onScroll:b[2]||(b[2]=O(()=>{},["prevent","stop"])),class:E(["fixed bg-background/90 backdrop-blur-sm border rounded-lg shadow-lg overflow-hidden flex flex-col z-40 transition-shadow",m.value?"border-primary shadow-xl":"border-border"])},[e("div",{ref_key:"handle",ref:o,class:"flex items-center justify-between px-4 py-2 border-b border-border bg-background/50 cursor-move select-none"},[e("div",pe,[c(t(T),{icon:"radix-icons:globe",class:"h-4 w-4 text-primary"}),b[3]||(b[3]=e("h3",{class:"text-sm font-semibold"},"Console",-1))]),e("div",he,[c(t(I),{"delay-duration":0},{default:w(()=>[c(t(L),null,{default:w(()=>[c(t(N),{"as-child":""},{default:w(()=>[c(A,{variant:"ghost",size:"icon",class:"h-6 w-6",onClick:v},{default:w(()=>[c(t(T),{icon:"radix-icons:trash",class:"h-3 w-3"})]),_:1})]),_:1}),c(t(H),null,{default:w(()=>[...b[4]||(b[4]=[e("p",null,"Clear Events",-1)])]),_:1})]),_:1})]),_:1}),c(t(I),{"delay-duration":0},{default:w(()=>[c(t(L),null,{default:w(()=>[c(t(N),{"as-child":""},{default:w(()=>[c(A,{variant:"ghost",size:"icon",class:"h-6 w-6",onClick:Q},{default:w(()=>[c(t(T),{icon:"radix-icons:reset",class:"h-3 w-3"})]),_:1})]),_:1}),c(t(H),null,{default:w(()=>[...b[5]||(b[5]=[e("p",null,"Reset Position & Size",-1)])]),_:1})]),_:1})]),_:1}),c(t(I),{"delay-duration":0},{default:w(()=>[c(t(L),null,{default:w(()=>[c(t(N),{"as-child":""},{default:w(()=>[c(A,{variant:"ghost",size:"icon",class:"h-6 w-6",onClick:b[0]||(b[0]=D=>t(i).debug.showWebSocketDebugger=!1)},{default:w(()=>[c(t(T),{icon:"radix-icons:cross-2",class:"h-3 w-3"})]),_:1})]),_:1}),c(t(H),null,{default:w(()=>[...b[6]||(b[6]=[e("p",null,"Close",-1)])]),_:1})]),_:1})]),_:1})])],512),e("div",{ref_key:"eventListRef",ref:S,class:"flex-1 overflow-y-auto p-2 space-y-1",onWheel:b[1]||(b[1]=O(()=>{},["stop"]))},[p.value.length===0?(d(),k("div",we," No events yet. Waiting for WebSocket activity... ")):C("",!0),(d(!0),k(R,null,ae(p.value,(D,M)=>(d(),k("div",{key:M,class:"text-xs font-mono p-2 rounded bg-muted/50 hover:bg-muted transition-colors cursor-pointer",onClick:G=>a(M)},[e("div",ve,[e("div",be,[c(t(T),{icon:_.value.has(M)?"radix-icons:chevron-down":"radix-icons:chevron-right",class:"h-3 w-3 flex-shrink-0"},null,8,["icon"]),e("span",{class:E(["font-semibold truncate",r(D)])},W(D.type),3)]),e("span",xe,W(D.timestamp),1)]),e("div",{class:E(["text-muted-foreground break-all",_.value.has(M)?"":"line-clamp-2"])},W(Z(D.data)),3)],8,me))),128))],544),e("div",ye,[e("span",null,W(p.value.length)+" events",1),e("span",ke,W(x.value.width)+"x"+W(x.value.height),1)]),e("div",{ref_key:"resizeHandle",ref:u,class:"absolute bottom-0 right-0 w-4 h-4 cursor-se-resize opacity-50 hover:opacity-100 transition-opacity"},[c(t(T),{icon:"radix-icons:corner-bottom-right",class:"w-4 h-4 text-muted-foreground"})],512)],38)):C("",!0)]))}}),Ce=async()=>new Promise(n=>{const i=window.open("about:blank","_blank","width=100,height=100");!i||i.closed||typeof i.closed>"u"?n({blocked:!0,message:"Popup blocker detected. Please allow popups for this site."}):(i.close(),n({blocked:!1,message:"No popup blocker detected."}))}),Se=async(n,i,g=5e3)=>new Promise(f=>{try{const o=i?new WebSocket(n,i):new WebSocket(n),u=setTimeout(()=>{o.readyState!==WebSocket.OPEN&&(o.close(),f({success:!1,message:"WebSocket connection timed out. This might be caused by a browser extension or firewall blocking the connection."}))},g);o.onopen=()=>{clearTimeout(u),o.close(),f({success:!0,message:"WebSocket connection successful."})},o.onerror=()=>{clearTimeout(u),o.close(),f({success:!1,message:"WebSocket connection failed. This might be caused by a browser extension or firewall blocking the connection."})}}catch(o){f({success:!1,message:`WebSocket connection error: ${o instanceof Error?o.message:String(o)}`})}});function We(){const n=y(!1),i=y({webSocket:{success:!1,message:""}});return{loading:n,results:i,runDiagnostics:async o=>{n.value=!0;const u=o?.wsUrl||"wss://topsyde-gaming.duckdns.org:3000",h=o?.testPopups??!1?await Ce():void 0,p=await Se(u,o?.protocol);return i.value={...h&&{popupBlocker:h},webSocket:p},n.value=!1,i.value},hasIssues:()=>{const o=!i.value.webSocket.success,u=i.value.popupBlocker?.blocked===!0;return o||u}}}const $e={key:0,class:"fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4"},De={class:"w-full max-w-2xl animate-in zoom-in-95 duration-200"},Me={class:"rounded-lg border border-border bg-card p-6 shadow-2xl space-y-4"},ze={key:0,class:"space-y-3"},Be={class:"flex-shrink-0 mt-0.5"},Pe={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-green-500",viewBox:"0 0 20 20",fill:"currentColor"},Te={key:1,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-destructive",viewBox:"0 0 20 20",fill:"currentColor"},Ae={class:"flex-1"},Ee={class:"text-sm text-muted-foreground mt-1"},je={key:0,class:"rounded-md bg-yellow-500/10 border border-yellow-500/50 p-4"},Ie={key:1,class:"flex items-center justify-center gap-2 p-3 rounded-md bg-muted/50 text-sm text-muted-foreground"},Le={key:1,class:"text-center py-8"},Ne={class:"flex gap-2 justify-center pt-2"},He=j({__name:"ConnectionDiagnosticModal",props:{wsUrl:{default:void 0},protocol:{default:void 0}},emits:["connectionSuccess","connectionFailed"],setup(n,{emit:i}){const g=n,f=i,o=We(),u=y(!1),m=y(!1),h=y(10);let p=null;const S=o.loading,_=o.results;async function x(){m.value=!1,h.value=10,(await o.runDiagnostics({wsUrl:g.wsUrl,protocol:g.protocol})).webSocket.success?(console.log("[ConnectionDiagnostic] Connection successful, emitting success"),f("connectionSuccess"),u.value=!1):(console.log("[ConnectionDiagnostic] Connection failed, showing diagnostic modal"),f("connectionFailed"),u.value=!0,$())}function $(){p&&clearInterval(p),p=setInterval(()=>{h.value--,h.value<=0&&(p&&clearInterval(p),m.value=!0)},1e3)}function l(){console.log("[ConnectionDiagnostic] Retrying connection..."),u.value=!1,x()}function r(){p&&clearInterval(p),u.value=!1}return ie(()=>{console.log("[ConnectionDiagnostic] Component mounted, running diagnostics..."),x()}),(v,a)=>(d(),P(V,{to:"body"},[c(Y,{name:"fade"},{default:w(()=>[u.value?(d(),k("div",$e,[e("div",De,[e("div",Me,[a[8]||(a[8]=e("div",{class:"text-center space-y-2"},[e("div",{class:"mx-auto w-16 h-16 rounded-full bg-destructive/10 flex items-center justify-center"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-8 w-8 text-destructive",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})])]),e("h2",{class:"text-2xl font-bold tracking-tight text-foreground"},"Connection Blocked"),e("p",{class:"text-sm text-muted-foreground"}," Unable to connect to the game server. Please check your browser settings. ")],-1)),t(S)?(d(),k("div",Le,[...a[5]||(a[5]=[e("svg",{class:"animate-spin h-8 w-8 mx-auto text-primary",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),e("p",{class:"text-sm text-muted-foreground mt-3"},"Running diagnostics...",-1)])])):(d(),k("div",ze,[e("div",{class:E(["flex items-start gap-3 p-3 rounded-md border",t(_).webSocket.success?"border-green-500/50 bg-green-500/10":"border-destructive/50 bg-destructive/10"])},[e("div",Be,[t(_).webSocket.success?(d(),k("svg",Pe,[...a[0]||(a[0]=[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"},null,-1)])])):(d(),k("svg",Te,[...a[1]||(a[1]=[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"},null,-1)])]))]),e("div",Ae,[a[2]||(a[2]=e("strong",{class:"text-sm font-semibold"},"WebSocket Connection:",-1)),e("p",Ee,W(t(_).webSocket.message),1)])],2),t(_).webSocket.success?C("",!0):(d(),k("div",je,[...a[3]||(a[3]=[e("h4",{class:"text-sm font-semibold text-foreground mb-2 flex items-center gap-2"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 text-yellow-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]),z(" Troubleshooting Tips ")],-1),e("ul",{class:"text-sm text-muted-foreground space-y-1.5 ml-6 list-disc"},[e("li",null,[e("strong",null,"Browser Extensions:"),z(" Disable ad blockers and privacy extensions "),e("ul",{class:"ml-4 mt-1 list-circle space-y-1"},[e("li",null,"uBlock Origin, AdBlock Plus, AdGuard"),e("li",null,"Privacy Badger, Ghostery, DuckDuckGo Privacy Essentials"),e("li",null,"NoScript, HTTPS Everywhere")])]),e("li",null,[e("strong",null,"Popup Blockers:"),z(" Allow popups for this site in browser settings ")]),e("li",null,[e("strong",null,"Firewall:"),z(" Check if your firewall is blocking WebSocket connections ")]),e("li",null,[e("strong",null,"VPN/Proxy:"),z(" Try disabling VPN or proxy if active")]),e("li",null,[e("strong",null,"Try:"),z(" Use incognito mode or a different browser (Chrome, Firefox, Edge) ")])],-1)])])),m.value?C("",!0):(d(),k("div",Ie,[a[4]||(a[4]=e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})],-1)),e("span",null,"You can retry in "+W(h.value)+" seconds",1)]))])),e("div",Ne,[c(t(A),{onClick:l,disabled:!m.value||t(S),variant:"default"},{default:w(()=>[...a[6]||(a[6]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),z(" Retry Connection ",-1)])]),_:1},8,["disabled"]),m.value?(d(),P(t(A),{key:0,onClick:r,variant:"outline"},{default:w(()=>[...a[7]||(a[7]=[z(" Close ",-1)])]),_:1})):C("",!0)])])])])):C("",!0)]),_:1})]))}}),Re=q(He,[["__scopeId","data-v-95637a00"]]),Ve=()=>{const n=F(),i=J(),g=re(),f=U(),o=K(["debug","ws"]);async function u(){if(n.isConnecting||n.isConnected){console.warn("[WS] Already connected or connecting");return}const l={username:f.username||"",password:f.password||"",api_key:"r_d_25c9dd62-ba12-44de-b303-67ef659ba7bd"};try{n.status="handshaking";const r=await _(l);if(!r.scene)throw new Error("No scene provided by server");console.log("[WS] Handshake successful:",r);const v={id:r.id,name:r.name},a=r.scene;n.setClientData(v),g.setActiveScene(a),m(v)}catch(r){throw n.status="disconnected",n.lastError=r,console.error("[WS] Connection failed:",r),r}}function m(l){const r=`${l.id}-${l.name}`;n.connect(r)}function h(){n.register("useWebsocketConnection",{data:x})}function p(){n.disconnect(),n.$reset()}function S(l){const r=n.getWebSocketInstance();if(!r||!n.isConnected)throw new Error("WebSocket not connected");const v=typeof l=="string"?l:JSON.stringify(l);r.send(v)}async function _(l){const v=await new fe("api","https://topsyde-gaming.duckdns.org:3000").handshake(l.username,l.password,l.api_key);return{id:v.data.id,name:v.data.name,scene:v.data.scene}}function x(l,r){try{if(r.type=="message"){console.log("[WS] Chat message received:",r);return}$({...r,data:r.content})}catch(v){console.error("[WS] Failed to parse message:",v)}}function $(l){i.debug.showWebSocketDebugger&&(o.$next("debug",{cta:"log",data:{...l,timestamp:new Date().toLocaleTimeString()}}),l.type=="scene"&&o.$next("scene",{cta:l.type,data:l}))}return{connect:u,register:h,disconnect:p,send:S,status:B(()=>n.status),isConnected:B(()=>n.isConnected),isConnecting:B(()=>n.isConnecting),clientData:B(()=>n.clientData)}},Ue={key:0,class:"fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"},Fe={class:"w-full max-w-md space-y-6 animate-in zoom-in-95 duration-200"},Ge={class:"rounded-lg border border-border bg-card p-6 shadow-2xl space-y-4"},Oe={class:"text-center space-y-2"},Je={class:"text-sm text-muted-foreground"},Xe={key:0,class:"rounded-md bg-destructive/10 p-3 text-sm text-destructive"},Ye={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},qe=j({__name:"WebSocketManager",props:{autoConnect:{type:Boolean,default:!0},autoDisconnect:{type:Boolean}},setup(n){const i=n,g=U(),f=F(),o=Ve(),u=y(!1),m=y(""),h=y(!1),p=y(!1),S=B(()=>"wss://topsyde-gaming.duckdns.org:3000"),_=B(()=>f.clientData?`${f.clientData.id}-${f.clientData.name}`:void 0);function x(){console.log("[WebSocketManager] Diagnostic passed, showing connect modal"),p.value=!0,h.value=!0}function $(){console.log("[WebSocketManager] Diagnostic failed, user will see troubleshooting"),p.value=!1,h.value=!1}async function l(){if(!g.isAuthenticated){console.warn("[WebSocketManager] Cannot connect: Not authenticated");return}u.value=!0,m.value="";try{console.log("[WebSocketManager] Connecting to WebSocket..."),await o.connect(),o.register(),console.log("✅ [WebSocketManager] Connected successfully!"),h.value=!1}catch(v){console.error("❌ [WebSocketManager] Connection failed:",v),m.value=v?.message||"Failed to connect. Please try again."}finally{u.value=!1}}function r(){o.disconnect()}return ce(()=>{i.autoConnect&&l()}),ue(r),(v,a)=>(d(),k(R,null,[t(g).isAuthenticated&&!t(f).isConnected?(d(),P(Re,{key:0,"ws-url":S.value,protocol:_.value,onConnectionSuccess:x,onConnectionFailed:$},null,8,["ws-url","protocol"])):C("",!0),(d(),P(V,{to:"body"},[c(Y,{name:"fade"},{default:w(()=>[h.value?(d(),k("div",Ue,[e("div",Fe,[e("div",Ge,[e("div",Oe,[a[0]||(a[0]=e("div",{class:"mx-auto w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-8 w-8 text-primary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M13 10V3L4 14h7v7l9-11h-7z"})])],-1)),a[1]||(a[1]=e("h2",{class:"text-2xl font-bold tracking-tight text-foreground"},"Connect to Game",-1)),e("p",Je," Welcome, "+W(t(g).username)+"! Click below to connect to the game server. ",1)]),m.value?(d(),k("div",Xe,W(m.value),1)):C("",!0),c(t(A),{onClick:l,class:"w-full h-11",disabled:u.value},{default:w(()=>[u.value?(d(),k("svg",Ye,[...a[2]||(a[2]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):C("",!0),z(" "+W(u.value?"Connecting...":"Connect to Server"),1)]),_:1},8,["disabled"]),a[3]||(a[3]=e("p",{class:"text-center text-xs text-muted-foreground"},"Secured with SSL/TLS encryption",-1))])])])):C("",!0)]),_:1})]))],64))}}),Ke=q(qe,[["__scopeId","data-v-b179d88a"]]),Qe={class:"game"},ot=j({__name:"Game",setup(n){const i=U(),g=F(),f=de();return X(()=>i.isAuthenticated,o=>{o||(console.log("User logged out, disconnecting WebSocket"),g.disconnect(),f.push("/login"))},{immediate:!0}),(o,u)=>(d(),k("div",Qe,[t(i).isAuthenticated?(d(),k(R,{key:0},[c(_e),t(i).isAuthenticated?(d(),P(Ke,{key:0,"auto-connect":!1})):C("",!0)],64)):C("",!0),t(g).isConnected?(d(),P(ge,{key:1})):C("",!0)]))}});export{ot as default};
