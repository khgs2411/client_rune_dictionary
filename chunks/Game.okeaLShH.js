import{d as T,B as F,C as K,p as b,l as D,D as Q,E as Z,F as ee,G,c as E,f as S,x as $,a as n,n as B,t as P,H as te,q as t,s,I as z,J as H,w as l,K as J,L as ne,y as C,T as U,M as j,N as L,_ as A,O as R,o as u,Q as se,R as oe,k as V,S as ae,A as re,U as ie,V as ce,W as le,z as de}from"./index.BxV0eWTe.js";import"./IsNumberOrRangeConstraint.B_UE5vHo.js";import{u as X,a as I,S as ue}from"./Scene.CdNjClDw.js";import{A as he}from"./auth.api.CErS-Rg5.js";const ge={class:"flex items-center gap-2"},fe={class:"flex items-center gap-1"},pe={key:0,class:"text-center text-sm text-muted-foreground py-8"},me=["onClick"],we={class:"flex items-start justify-between gap-2 mb-1"},ye={class:"flex items-center gap-1 flex-1 min-w-0"},xe={class:"text-muted-foreground text-[10px] whitespace-nowrap"},be={class:"px-4 py-2 border-t border-border bg-background/50 flex items-center justify-between text-xs text-muted-foreground"},ve={class:"text-[10px]"},_e=T({__name:"DebugConsole",setup(i){const y=F(),d=K(),v=b(null),h=b(null),p=b(null),m=b(!1),_=b({x:0,y:0,width:0,height:0}),w=b([]),W=b(null),g=b(new Set),r=D({get:()=>({width:d.debugConsole.width,height:d.debugConsole.height}),set:e=>d.updateDebugConsole({width:e.width,height:e.height})});X("debug",{log(e){w.value.push(e)}});const{x:M,y:o}=Q(v,{initialValue:{x:d.debugConsole.x,y:d.debugConsole.y},handle:h});function a(e){return{"text-green-500":e.type.includes("connect"),"text-red-500":e.type.includes("error")||e.type.includes("disconnect"),"text-blue-500":e.type.includes("match"),"text-yellow-500":e.type.includes("system"),"text-purple-500":e.type.includes("whisper"),"text-gray-500":e.type.includes("pong")}}function f(){w.value=[],g.value.clear()}function N(e){g.value.has(e)?g.value.delete(e):g.value.add(e)}function Y(){const e={x:window.innerWidth-400-16,y:64,width:400,height:Math.min(window.innerHeight*.6,600)};d.updateDebugConsole(e),M.value=e.x,o.value=e.y}function q(e){if(typeof e=="string")return e;if(typeof e=="object")try{return JSON.stringify(e,null,2)}catch{return String(e)}return String(e)}return Z([M,o],([e,c])=>{const x=Math.round(e),k=Math.round(c);M.value=x,o.value=k,d.updateDebugConsole({x,y:k})},{debounce:300}),ee(p,{onSwipeStart:e=>{m.value=!0,_.value={x:e.x,y:e.y,width:r.value.width,height:r.value.height}},onSwipe:e=>{if(!m.value)return;const c=e.x-_.value.x,x=e.y-_.value.y,k=Math.max(300,_.value.width+c),O=Math.max(200,_.value.height+x);r.value={width:k,height:O}},onSwipeEnd:()=>{r.value={width:Math.round(r.value.width),height:Math.round(r.value.height)},m.value=!1}}),G(()=>w.value.length,async()=>{await se(),W.value&&(W.value.scrollTop=W.value.scrollHeight)}),(e,c)=>(u(),E(U,{to:"body"},[n(y).debug.showWebSocketDebugger?(u(),S("div",{key:0,ref_key:"draggableContainer",ref:v,style:te({left:`${n(M)}px`,top:`${n(o)}px`,width:`${r.value.width}px`,height:`${r.value.height}px`}),onScroll:c[2]||(c[2]=P(()=>{},["prevent","stop"])),class:B(["fixed bg-background/90 backdrop-blur-sm border rounded-lg shadow-lg overflow-hidden flex flex-col z-40 transition-shadow",m.value?"border-primary shadow-xl":"border-border"])},[t("div",{ref_key:"handle",ref:h,class:"flex items-center justify-between px-4 py-2 border-b border-border bg-background/50 cursor-move select-none"},[t("div",ge,[s(n(z),{icon:"radix-icons:globe",class:"h-4 w-4 text-primary"}),c[3]||(c[3]=t("h3",{class:"text-sm font-semibold"},"Console",-1))]),t("div",fe,[s(n(H),{"delay-duration":0},{default:l(()=>[s(n(j),null,{default:l(()=>[s(n(L),{"as-child":""},{default:l(()=>[s(A,{variant:"ghost",size:"icon",class:"h-6 w-6",onClick:f},{default:l(()=>[s(n(z),{icon:"radix-icons:trash",class:"h-3 w-3"})]),_:1})]),_:1}),s(n(R),null,{default:l(()=>[...c[4]||(c[4]=[t("p",null,"Clear Events",-1)])]),_:1})]),_:1})]),_:1}),s(n(H),{"delay-duration":0},{default:l(()=>[s(n(j),null,{default:l(()=>[s(n(L),{"as-child":""},{default:l(()=>[s(A,{variant:"ghost",size:"icon",class:"h-6 w-6",onClick:Y},{default:l(()=>[s(n(z),{icon:"radix-icons:reset",class:"h-3 w-3"})]),_:1})]),_:1}),s(n(R),null,{default:l(()=>[...c[5]||(c[5]=[t("p",null,"Reset Position & Size",-1)])]),_:1})]),_:1})]),_:1}),s(n(H),{"delay-duration":0},{default:l(()=>[s(n(j),null,{default:l(()=>[s(n(L),{"as-child":""},{default:l(()=>[s(A,{variant:"ghost",size:"icon",class:"h-6 w-6",onClick:c[0]||(c[0]=x=>n(y).debug.showWebSocketDebugger=!1)},{default:l(()=>[s(n(z),{icon:"radix-icons:cross-2",class:"h-3 w-3"})]),_:1})]),_:1}),s(n(R),null,{default:l(()=>[...c[6]||(c[6]=[t("p",null,"Close",-1)])]),_:1})]),_:1})]),_:1})])],512),t("div",{ref_key:"eventListRef",ref:W,class:"flex-1 overflow-y-auto p-2 space-y-1",onWheel:c[1]||(c[1]=P(()=>{},["stop"]))},[w.value.length===0?(u(),S("div",pe," No events yet. Waiting for WebSocket activity... ")):$("",!0),(u(!0),S(J,null,ne(w.value,(x,k)=>(u(),S("div",{key:k,class:"text-xs font-mono p-2 rounded bg-muted/50 hover:bg-muted transition-colors cursor-pointer",onClick:O=>N(k)},[t("div",we,[t("div",ye,[s(n(z),{icon:g.value.has(k)?"radix-icons:chevron-down":"radix-icons:chevron-right",class:"h-3 w-3 flex-shrink-0"},null,8,["icon"]),t("span",{class:B(["font-semibold truncate",a(x)])},C(x.type),3)]),t("span",xe,C(x.timestamp),1)]),t("div",{class:B(["text-muted-foreground break-all",g.value.has(k)?"":"line-clamp-2"])},C(q(x.data)),3)],8,me))),128))],544),t("div",be,[t("span",null,C(w.value.length)+" events",1),t("span",ve,C(r.value.width)+"x"+C(r.value.height),1)]),t("div",{ref_key:"resizeHandle",ref:p,class:"absolute bottom-0 right-0 w-4 h-4 cursor-se-resize opacity-50 hover:opacity-100 transition-opacity"},[s(n(z),{icon:"radix-icons:corner-bottom-right",class:"w-4 h-4 text-muted-foreground"})],512)],38)):$("",!0)]))}}),ke=()=>{const i=I(),y=F(),d=oe(),v=V(),h=X(["debug","ws"]);async function p(){if(i.isConnecting||i.isConnected){console.warn("[WS] Already connected or connecting");return}const o={username:v.username||"",password:v.password||"",api_key:"r_d_25c9dd62-ba12-44de-b303-67ef659ba7bd"};try{i.status="handshaking";const a=await g(o);if(!a.scene)throw new Error("No scene provided by server");console.log("[WS] Handshake successful:",a);const f={id:a.id,name:a.name},N=a.scene;i.setClientData(f),d.setActiveScene(N),m(f)}catch(a){throw i.status="disconnected",i.lastError=a,console.error("[WS] Connection failed:",a),a}}function m(o){const a=`${o.id}-${o.name}`;i.connect(a)}function _(){i.register("useWebsocketConnection",{data:r})}function w(){i.disconnect(),i.$reset()}function W(o){const a=i.getWebSocketInstance();if(!a||!i.isConnected)throw new Error("WebSocket not connected");const f=typeof o=="string"?o:JSON.stringify(o);a.send(f)}async function g(o){const f=await new he("api","https://topsyde-gaming.duckdns.org:3000").handshake(o.username,o.password,o.api_key);return{id:f.data.id,name:f.data.name,scene:f.data.scene}}function r(o,a){try{if(a.type=="message"){console.log("[WS] Chat message received:",a);return}M({...a,data:a.content})}catch(f){console.error("[WS] Failed to parse message:",f)}}function M(o){y.debug.showWebSocketDebugger&&(h.$next("debug",{cta:"log",data:{...o,timestamp:new Date().toLocaleTimeString()}}),o.type=="scene"&&h.$next("scene",{cta:o.type,data:o}))}return{connect:p,register:_,disconnect:w,send:W,status:D(()=>i.status),isConnected:D(()=>i.isConnected),isConnecting:D(()=>i.isConnecting),clientData:D(()=>i.clientData)}},Ce={key:0,class:"fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"},Se={class:"w-full max-w-md space-y-6 animate-in zoom-in-95 duration-200"},We={class:"rounded-lg border border-border bg-card p-6 shadow-2xl space-y-4"},$e={class:"text-center space-y-2"},Me={class:"text-sm text-muted-foreground"},ze={key:0,class:"rounded-md bg-destructive/10 p-3 text-sm text-destructive"},De={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Ae=T({__name:"WebSocketManager",props:{autoConnect:{type:Boolean,default:!0},autoDisconnect:{type:Boolean}},setup(i){const y=i,d=V(),v=I(),h=ke(),p=b(!1),m=b(""),_=D(()=>d.isAuthenticated&&!v.isConnected);async function w(){if(!d.isAuthenticated){console.warn("[WebSocketManager] Cannot connect: Not authenticated");return}p.value=!0,m.value="";try{console.log("[WebSocketManager] Connecting to WebSocket..."),await h.connect(),h.register(),console.log("✅ [WebSocketManager] Connected successfully!")}catch(g){console.error("❌ [WebSocketManager] Connection failed:",g),m.value=g?.message||"Failed to connect. Please try again."}finally{p.value=!1}}function W(){h.disconnect()}return ae(()=>{y.autoConnect&&w()}),ce(W),(g,r)=>(u(),E(U,{to:"body"},[s(ie,{name:"fade"},{default:l(()=>[_.value?(u(),S("div",Ce,[t("div",Se,[t("div",We,[t("div",$e,[r[0]||(r[0]=t("div",{class:"mx-auto w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-8 w-8 text-primary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M13 10V3L4 14h7v7l9-11h-7z"})])],-1)),r[1]||(r[1]=t("h2",{class:"text-2xl font-bold tracking-tight text-foreground"},"Connect to Game",-1)),t("p",Me," Welcome, "+C(n(d).username)+"! Click below to connect to the game server. ",1)]),m.value?(u(),S("div",ze,C(m.value),1)):$("",!0),s(n(A),{onClick:w,class:"w-full h-11",disabled:p.value},{default:l(()=>[p.value?(u(),S("svg",De,[...r[2]||(r[2]=[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):$("",!0),re(" "+C(p.value?"Connecting...":"Connect to Server"),1)]),_:1},8,["disabled"]),r[3]||(r[3]=t("p",{class:"text-center text-xs text-muted-foreground"},"Secured with SSL/TLS encryption",-1))])])])):$("",!0)]),_:1})]))}}),Ee=le(Ae,[["__scopeId","data-v-63a6e290"]]),Ne={class:"game"},Re=T({__name:"Game",setup(i){const y=V(),d=I(),v=de();return G(()=>y.isAuthenticated,h=>{h||(console.log("User logged out, disconnecting WebSocket"),d.disconnect(),v.push("/login"))},{immediate:!0}),(h,p)=>(u(),S("div",Ne,[n(y).isAuthenticated?(u(),S(J,{key:0},[s(_e),n(y).isAuthenticated?(u(),E(Ee,{key:0,"auto-connect":!1})):$("",!0)],64)):$("",!0),n(d).isConnected?(u(),E(ue,{key:1})):$("",!0)]))}});export{Re as default};
