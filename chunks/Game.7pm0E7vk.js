import{d as j,B as X,C as ee,p as y,l as B,D as te,E as se,F as oe,G as U,c as A,f as k,x as C,a as t,n as E,t as Y,H as ne,q as e,s as r,I as T,J as L,w,K as V,L as ae,y as W,T as G,M as N,N as H,_ as P,O as R,o as p,Q as le,R as q,A as z,S as K,U as re,k as O,V as ie,W as ce,z as ue}from"./index.YPmqP-1-.js";import"./IsNumberOrRangeConstraint.B_UE5vHo.js";import{u as Q,a as F,S as de}from"./Scene.BljqqxEO.js";import{A as ge}from"./auth.api.CErS-Rg5.js";const pe={class:"flex items-center gap-2"},fe={class:"flex items-center gap-1"},he={key:0,class:"text-center text-sm text-muted-foreground py-8"},we=["onClick"],me={class:"flex items-start justify-between gap-2 mb-1"},ve={class:"flex items-center gap-1 flex-1 min-w-0"},be={class:"text-muted-foreground text-[10px] whitespace-nowrap"},xe={class:"px-4 py-2 border-t border-border bg-background/50 flex items-center justify-between text-xs text-muted-foreground"},ye={class:"text-[10px]"},ke=j({__name:"DebugConsole",setup(a){const i=X(),u=ee(),f=y(null),o=y(null),d=y(null),x=y(!1),g=y({x:0,y:0,width:0,height:0}),m=y([]),S=y(null),_=y(new Set),v=B({get:()=>({width:u.debugConsole.width,height:u.debugConsole.height}),set:s=>u.updateDebugConsole({width:s.width,height:s.height})});Q("debug",{log(s){m.value.push(s)}});const{x:$,y:l}=te(f,{initialValue:{x:u.debugConsole.x,y:u.debugConsole.y},handle:o});function c(s){return{"text-green-500":s.type.includes("connect"),"text-red-500":s.type.includes("error")||s.type.includes("disconnect"),"text-blue-500":s.type.includes("match"),"text-yellow-500":s.type.includes("system"),"text-purple-500":s.type.includes("whisper"),"text-gray-500":s.type.includes("pong")}}function h(){m.value=[],_.value.clear()}function n(s){_.value.has(s)?_.value.delete(s):_.value.add(s)}function I(){const s={x:window.innerWidth-400-16,y:64,width:400,height:Math.min(window.innerHeight*.6,600)};u.updateDebugConsole(s),$.value=s.x,l.value=s.y}function Z(s){if(typeof s=="string")return s;if(typeof s=="object")try{return JSON.stringify(s,null,2)}catch{return String(s)}return String(s)}return se([$,l],([s,b])=>{const M=Math.round(s),D=Math.round(b);$.value=M,l.value=D,u.updateDebugConsole({x:M,y:D})},{debounce:300}),oe(d,{onSwipeStart:s=>{x.value=!0,g.value={x:s.x,y:s.y,width:v.value.width,height:v.value.height}},onSwipe:s=>{if(!x.value)return;const b=s.x-g.value.x,M=s.y-g.value.y,D=Math.max(300,g.value.width+b),J=Math.max(200,g.value.height+M);v.value={width:D,height:J}},onSwipeEnd:()=>{v.value={width:Math.round(v.value.width),height:Math.round(v.value.height)},x.value=!1}}),U(()=>m.value.length,async()=>{await le(),S.value&&(S.value.scrollTop=S.value.scrollHeight)}),(s,b)=>(p(),A(G,{to:"body"},[t(i).debug.showWebSocketDebugger?(p(),k("div",{key:0,ref_key:"draggableContainer",ref:f,style:ne({left:`${t($)}px`,top:`${t(l)}px`,width:`${v.value.width}px`,height:`${v.value.height}px`}),onScroll:b[2]||(b[2]=Y(()=>{},["prevent","stop"])),class:E(["fixed bg-background/90 backdrop-blur-sm border rounded-lg shadow-lg overflow-hidden flex flex-col z-40 transition-shadow",x.value?"border-primary shadow-xl":"border-border"])},[e("div",{ref_key:"handle",ref:o,class:"flex items-center justify-between px-4 py-2 border-b border-border bg-background/50 cursor-move select-none"},[e("div",pe,[r(t(T),{icon:"radix-icons:globe",class:"h-4 w-4 text-primary"}),b[3]||(b[3]=e("h3",{class:"text-sm font-semibold"},"Console",-1))]),e("div",fe,[r(t(L),{"delay-duration":0},{default:w(()=>[r(t(N),null,{default:w(()=>[r(t(H),{"as-child":""},{default:w(()=>[r(P,{variant:"ghost",size:"icon",class:"h-6 w-6",onClick:h},{default:w(()=>[r(t(T),{icon:"radix-icons:trash",class:"h-3 w-3"})]),_:1})]),_:1}),r(t(R),null,{default:w(()=>[...b[4]||(b[4]=[e("p",null,"Clear Events",-1)])]),_:1})]),_:1})]),_:1}),r(t(L),{"delay-duration":0},{default:w(()=>[r(t(N),null,{default:w(()=>[r(t(H),{"as-child":""},{default:w(()=>[r(P,{variant:"ghost",size:"icon",class:"h-6 w-6",onClick:I},{default:w(()=>[r(t(T),{icon:"radix-icons:reset",class:"h-3 w-3"})]),_:1})]),_:1}),r(t(R),null,{default:w(()=>[...b[5]||(b[5]=[e("p",null,"Reset Position & Size",-1)])]),_:1})]),_:1})]),_:1}),r(t(L),{"delay-duration":0},{default:w(()=>[r(t(N),null,{default:w(()=>[r(t(H),{"as-child":""},{default:w(()=>[r(P,{variant:"ghost",size:"icon",class:"h-6 w-6",onClick:b[0]||(b[0]=M=>t(i).debug.showWebSocketDebugger=!1)},{default:w(()=>[r(t(T),{icon:"radix-icons:cross-2",class:"h-3 w-3"})]),_:1})]),_:1}),r(t(R),null,{default:w(()=>[...b[6]||(b[6]=[e("p",null,"Close",-1)])]),_:1})]),_:1})]),_:1})])],512),e("div",{ref_key:"eventListRef",ref:S,class:"flex-1 overflow-y-auto p-2 space-y-1",onWheel:b[1]||(b[1]=Y(()=>{},["stop"]))},[m.value.length===0?(p(),k("div",he," No events yet. Waiting for WebSocket activity... ")):C("",!0),(p(!0),k(V,null,ae(m.value,(M,D)=>(p(),k("div",{key:D,class:"text-xs font-mono p-2 rounded bg-muted/50 hover:bg-muted transition-colors cursor-pointer",onClick:J=>n(D)},[e("div",me,[e("div",ve,[r(t(T),{icon:_.value.has(D)?"radix-icons:chevron-down":"radix-icons:chevron-right",class:"h-3 w-3 flex-shrink-0"},null,8,["icon"]),e("span",{class:E(["font-semibold truncate",c(M)])},W(M.type),3)]),e("span",be,W(M.timestamp),1)]),e("div",{class:E(["text-muted-foreground break-all",_.value.has(D)?"":"line-clamp-2"])},W(Z(M.data)),3)],8,we))),128))],544),e("div",xe,[e("span",null,W(m.value.length)+" events",1),e("span",ye,W(v.value.width)+"x"+W(v.value.height),1)]),e("div",{ref_key:"resizeHandle",ref:d,class:"absolute bottom-0 right-0 w-4 h-4 cursor-se-resize opacity-50 hover:opacity-100 transition-opacity"},[r(t(T),{icon:"radix-icons:corner-bottom-right",class:"w-4 h-4 text-muted-foreground"})],512)],38)):C("",!0)]))}}),_e=async()=>new Promise(a=>{const i=window.open("about:blank","_blank","width=100,height=100");!i||i.closed||typeof i.closed>"u"?a({blocked:!0,message:"Popup blocker detected. Please allow popups for this site."}):(i.close(),a({blocked:!1,message:"No popup blocker detected."}))}),Ce=async(a,i,u=5e3)=>new Promise(f=>{try{const o=i?new WebSocket(a,i):new WebSocket(a),d=setTimeout(()=>{o.readyState!==WebSocket.OPEN&&(o.close(),f({success:!1,message:"WebSocket connection timed out. This might be caused by a browser extension or firewall blocking the connection."}))},u);o.onopen=()=>{clearTimeout(d),o.close(),f({success:!0,message:"WebSocket connection successful."})},o.onerror=()=>{clearTimeout(d),o.close(),f({success:!1,message:"WebSocket connection failed. This might be caused by a browser extension or firewall blocking the connection."})}}catch(o){f({success:!1,message:`WebSocket connection error: ${o instanceof Error?o.message:String(o)}`})}});function Se(){const a=y(!1),i=y({webSocket:{success:!1,message:""}});return{loading:a,results:i,runDiagnostics:async o=>{a.value=!0;const d=o?.wsUrl||"wss://topsyde-gaming.duckdns.org:3000",g=o?.testPopups??!1?await _e():void 0,m=await Ce(d,o?.protocol);return i.value={...g&&{popupBlocker:g},webSocket:m},a.value=!1,i.value},hasIssues:()=>{const o=!i.value.webSocket.success,d=i.value.popupBlocker?.blocked===!0;return o||d}}}const We={key:0,class:"fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4"},$e={class:"w-full max-w-2xl animate-in zoom-in-95 duration-200"},Me={class:"rounded-lg border border-border bg-card p-6 shadow-2xl space-y-4"},De={key:0,class:"space-y-3"},ze={class:"flex-shrink-0 mt-0.5"},Be={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-green-500",viewBox:"0 0 20 20",fill:"currentColor"},Te={key:1,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-destructive",viewBox:"0 0 20 20",fill:"currentColor"},Pe={class:"flex-1"},Ae={class:"text-sm text-muted-foreground mt-1"},Ee={key:0,class:"rounded-md bg-yellow-500/10 border border-yellow-500/50 p-4"},je={key:1,class:"flex items-center justify-center gap-2 p-3 rounded-md bg-muted/50 text-sm text-muted-foreground"},Ie={key:1,class:"text-center py-8"},Le={class:"flex gap-2 justify-center pt-2"},Ne=j({__name:"ConnectionDiagnosticModal",props:{visible:{type:Boolean,default:!1},wsUrl:{default:void 0},protocol:{default:void 0}},emits:["update:visible","retry","close"],setup(a,{emit:i}){const u=a,f=i,o=Se(),d=y(!1),x=y(10);let g=null;const m=y(u.visible),S=o.loading,_=o.results;U(()=>u.visible,h=>{m.value=h,h&&v()});async function v(){d.value=!1,x.value=10,await o.runDiagnostics({wsUrl:u.wsUrl,protocol:u.protocol}),$()}function $(){g&&clearInterval(g),g=setInterval(()=>{x.value--,x.value<=0&&(g&&clearInterval(g),d.value=!0)},1e3)}function l(){f("retry"),v()}function c(){g&&clearInterval(g),m.value=!1,f("update:visible",!1),f("close")}return(h,n)=>(p(),A(G,{to:"body"},[r(q,{name:"fade"},{default:w(()=>[m.value?(p(),k("div",We,[e("div",$e,[e("div",Me,[n[8]||(n[8]=e("div",{class:"text-center space-y-2"},[e("div",{class:"mx-auto w-16 h-16 rounded-full bg-destructive/10 flex items-center justify-center"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-8 w-8 text-destructive",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})])]),e("h2",{class:"text-2xl font-bold tracking-tight text-foreground"},"Connection Blocked"),e("p",{class:"text-sm text-muted-foreground"}," Unable to connect to the game server. Please check your browser settings. ")],-1)),t(S)?(p(),k("div",Ie,[...n[5]||(n[5]=[e("svg",{class:"animate-spin h-8 w-8 mx-auto text-primary",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),e("p",{class:"text-sm text-muted-foreground mt-3"},"Running diagnostics...",-1)])])):(p(),k("div",De,[e("div",{class:E(["flex items-start gap-3 p-3 rounded-md border",t(_).webSocket.success?"border-green-500/50 bg-green-500/10":"border-destructive/50 bg-destructive/10"])},[e("div",ze,[t(_).webSocket.success?(p(),k("svg",Be,[...n[0]||(n[0]=[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"},null,-1)])])):(p(),k("svg",Te,[...n[1]||(n[1]=[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"},null,-1)])]))]),e("div",Pe,[n[2]||(n[2]=e("strong",{class:"text-sm font-semibold"},"WebSocket Connection:",-1)),e("p",Ae,W(t(_).webSocket.message),1)])],2),t(_).webSocket.success?C("",!0):(p(),k("div",Ee,[...n[3]||(n[3]=[e("h4",{class:"text-sm font-semibold text-foreground mb-2 flex items-center gap-2"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 text-yellow-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]),z(" Troubleshooting Tips ")],-1),e("ul",{class:"text-sm text-muted-foreground space-y-1.5 ml-6 list-disc"},[e("li",null,[e("strong",null,"Browser Extensions:"),z(" Disable ad blockers and privacy extensions "),e("ul",{class:"ml-4 mt-1 list-circle space-y-1"},[e("li",null,"uBlock Origin, AdBlock Plus, AdGuard"),e("li",null,"Privacy Badger, Ghostery, DuckDuckGo Privacy Essentials"),e("li",null,"NoScript, HTTPS Everywhere")])]),e("li",null,[e("strong",null,"Popup Blockers:"),z(" Allow popups for this site in browser settings ")]),e("li",null,[e("strong",null,"Firewall:"),z(" Check if your firewall is blocking WebSocket connections ")]),e("li",null,[e("strong",null,"VPN/Proxy:"),z(" Try disabling VPN or proxy if active")]),e("li",null,[e("strong",null,"Try:"),z(" Use incognito mode or a different browser (Chrome, Firefox, Edge) ")])],-1)])])),d.value?C("",!0):(p(),k("div",je,[n[4]||(n[4]=e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})],-1)),e("span",null,"You can retry in "+W(x.value)+" seconds",1)]))])),e("div",Le,[r(t(P),{onClick:l,disabled:!d.value||t(S),variant:"default"},{default:w(()=>[...n[6]||(n[6]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),z(" Retry Connection ",-1)])]),_:1},8,["disabled"]),d.value?(p(),A(t(P),{key:0,onClick:c,variant:"outline"},{default:w(()=>[...n[7]||(n[7]=[z(" Close ",-1)])]),_:1})):C("",!0)])])])])):C("",!0)]),_:1})]))}}),He=K(Ne,[["__scopeId","data-v-b4280cdd"]]),Re=()=>{const a=F(),i=X(),u=re(),f=O(),o=Q(["debug","ws"]);async function d(){if(a.isConnecting||a.isConnected){console.warn("[WS] Already connected or connecting");return}const l={username:f.username||"",password:f.password||"",api_key:"r_d_25c9dd62-ba12-44de-b303-67ef659ba7bd"};try{a.status="handshaking";const c=await _(l);if(!c.scene)throw new Error("No scene provided by server");console.log("[WS] Handshake successful:",c);const h={id:c.id,name:c.name},n=c.scene;a.setClientData(h),u.setActiveScene(n),x(h)}catch(c){throw a.status="disconnected",a.lastError=c,console.error("[WS] Connection failed:",c),c}}function x(l){const c=`${l.id}-${l.name}`;a.connect(c)}function g(){a.register("useWebsocketConnection",{data:v})}function m(){a.disconnect(),a.$reset()}function S(l){const c=a.getWebSocketInstance();if(!c||!a.isConnected)throw new Error("WebSocket not connected");const h=typeof l=="string"?l:JSON.stringify(l);c.send(h)}async function _(l){const h=await new ge("api","https://topsyde-gaming.duckdns.org:3000").handshake(l.username,l.password,l.api_key);return{id:h.data.id,name:h.data.name,scene:h.data.scene}}function v(l,c){try{if(c.type=="message"){console.log("[WS] Chat message received:",c);return}$({...c,data:c.content})}catch(h){console.error("[WS] Failed to parse message:",h)}}function $(l){i.debug.showWebSocketDebugger&&(o.$next("debug",{cta:"log",data:{...l,timestamp:new Date().toLocaleTimeString()}}),l.type=="scene"&&o.$next("scene",{cta:l.type,data:l}))}return{connect:d,register:g,disconnect:m,send:S,status:B(()=>a.status),isConnected:B(()=>a.isConnected),isConnecting:B(()=>a.isConnecting),clientData:B(()=>a.clientData)}},Ue={key:0,class:"fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"},Ve={class:"w-full max-w-md space-y-6 animate-in zoom-in-95 duration-200"},Ge={class:"rounded-lg border border-border bg-card p-6 shadow-2xl space-y-4"},Oe={class:"text-center space-y-2"},Fe={class:"text-sm text-muted-foreground"},Je={key:0,class:"rounded-md bg-destructive/10 p-3 text-sm text-destructive"},Ye={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Xe=j({__name:"WebSocketManager",props:{autoConnect:{type:Boolean,default:!0},autoDisconnect:{type:Boolean}},setup(a){const i=a,u=O(),f=F(),o=Re(),d=y(!1),x=y(""),g=y(!1),m=y(0),S=B(()=>"wss://topsyde-gaming.duckdns.org:3000"),_=B(()=>u.isAuthenticated&&!f.isConnected);async function v(){if(!u.isAuthenticated){console.warn("[WebSocketManager] Cannot connect: Not authenticated");return}d.value=!0,x.value="",m.value++;try{console.log("[WebSocketManager] Connecting to WebSocket..."),await o.connect(),o.register(),console.log("✅ [WebSocketManager] Connected successfully!"),m.value=0}catch(h){console.error("❌ [WebSocketManager] Connection failed:",h),x.value=h?.message||"Failed to connect. Please try again.",m.value>=2&&(console.warn("[WebSocketManager] Multiple connection failures, showing diagnostic modal"),g.value=!0)}finally{d.value=!1}}function $(){console.log("[WebSocketManager] Retrying connection from diagnostic modal..."),g.value=!1,m.value=0,v()}function l(){console.log("[WebSocketManager] Diagnostic modal closed"),g.value=!1}function c(){o.disconnect()}return ie(()=>{i.autoConnect&&v()}),ce(c),(h,n)=>(p(),k(V,null,[(p(),A(G,{to:"body"},[r(q,{name:"fade"},{default:w(()=>[_.value?(p(),k("div",Ue,[e("div",Ve,[e("div",Ge,[e("div",Oe,[n[1]||(n[1]=e("div",{class:"mx-auto w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-8 w-8 text-primary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M13 10V3L4 14h7v7l9-11h-7z"})])],-1)),n[2]||(n[2]=e("h2",{class:"text-2xl font-bold tracking-tight text-foreground"},"Connect to Game",-1)),e("p",Fe," Welcome, "+W(t(u).username)+"! Click below to connect to the game server. ",1)]),x.value?(p(),k("div",Je,W(x.value),1)):C("",!0),r(t(P),{onClick:v,class:"w-full h-11",disabled:d.value},{default:w(()=>[d.value?(p(),k("svg",Ye,[...n[3]||(n[3]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):C("",!0),z(" "+W(d.value?"Connecting...":"Connect to Server"),1)]),_:1},8,["disabled"]),n[4]||(n[4]=e("p",{class:"text-center text-xs text-muted-foreground"},"Secured with SSL/TLS encryption",-1))])])])):C("",!0)]),_:1})])),r(He,{visible:g.value,"ws-url":S.value,protocol:t(f).clientData?`${t(f).clientData.id}-${t(f).clientData.name}`:void 0,onRetry:$,onClose:l,"onUpdate:visible":n[0]||(n[0]=I=>g.value=I)},null,8,["visible","ws-url","protocol"])],64))}}),qe=K(Xe,[["__scopeId","data-v-2d7d9126"]]),Ke={class:"game"},st=j({__name:"Game",setup(a){const i=O(),u=F(),f=ue();return U(()=>i.isAuthenticated,o=>{o||(console.log("User logged out, disconnecting WebSocket"),u.disconnect(),f.push("/login"))},{immediate:!0}),(o,d)=>(p(),k("div",Ke,[t(i).isAuthenticated?(p(),k(V,{key:0},[r(ke),t(i).isAuthenticated?(p(),A(qe,{key:0,"auto-connect":!1})):C("",!0)],64)):C("",!0),t(u).isConnected?(p(),A(de,{key:1})):C("",!0)]))}});export{st as default};
